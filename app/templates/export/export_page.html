{% extends "base.html" %}

{% block title %}Exportar Dados - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">
                <i class="bi bi-download me-2 text-primary"></i>
                Exportar Dados
                {% if task %}
                    - {{ task.name }}
                {% endif %}
            </h1>
            <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

{% if task %}
<!-- Informações da Tarefa -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">{{ task.name }}</h5>
                        <p class="text-muted mb-0">
                            <i class="bi bi-link me-1"></i>
                            <a href="{{ task.url }}" target="_blank" class="text-decoration-none">
                                {{ task.url }}
                            </a>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-database me-1"></i>
                            {{ data_count }} registros disponíveis
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Formulário de Exportação -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear me-2"></i>
                    Configurações de Exportação
                </h5>
            </div>
            <div class="card-body">
                <form id="exportForm" method="POST">
                    {% if task %}
                        <input type="hidden" name="task_id" value="{{ task.id }}">
                    {% endif %}
                    
                    <!-- Seleção de Tarefas (se não especificada) -->
                    {% if not task %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-list-check me-1"></i>
                                Selecionar Tarefas
                            </h6>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAllTasks" onchange="toggleAllTasks()">
                                <label class="form-check-label" for="selectAllTasks">
                                    <strong>Selecionar Todas as Tarefas</strong>
                                </label>
                            </div>
                            
                            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                {% for available_task in available_tasks %}
                                <div class="form-check">
                                    <input class="form-check-input task-checkbox" type="checkbox" 
                                           name="task_ids" value="{{ available_task.id }}" 
                                           id="task_{{ available_task.id }}">
                                    <label class="form-check-label" for="task_{{ available_task.id }}">
                                        {{ available_task.name }}
                                        <small class="text-muted d-block">{{ available_task.items_extracted or 0 }} registros</small>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Tipos de Dados -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-collection me-1"></i>
                                Tipos de Dados para Exportar
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="post" id="export_posts" checked>
                                <label class="form-check-label" for="export_posts">
                                    <i class="bi bi-file-text me-1 text-primary"></i>
                                    Posts
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="comment" id="export_comments" checked>
                                <label class="form-check-label" for="export_comments">
                                    <i class="bi bi-chat me-1 text-info"></i>
                                    Comentários
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="profile" id="export_profile">
                                <label class="form-check-label" for="export_profile">
                                    <i class="bi bi-person me-1 text-success"></i>
                                    Informações de Perfil
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="likes" id="export_likes">
                                <label class="form-check-label" for="export_likes">
                                    <i class="bi bi-heart me-1 text-danger"></i>
                                    Dados de Likes
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="shares" id="export_shares">
                                <label class="form-check-label" for="export_shares">
                                    <i class="bi bi-share me-1 text-warning"></i>
                                    Dados de Compartilhamentos
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="data_types" 
                                       value="media" id="export_media">
                                <label class="form-check-label" for="export_media">
                                    <i class="bi bi-image me-1 text-secondary"></i>
                                    URLs de Mídia
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opções de Formatação -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-file-earmark-excel me-1"></i>
                                Opções de Formatação
                            </h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="filename" class="form-label">Nome do Arquivo</label>
                            <input type="text" class="form-control" id="filename" name="filename" 
                                   value="facebook_data_{{ moment().format('YYYY-MM-DD') }}" 
                                   placeholder="facebook_data_2024-01-15">
                            <div class="form-text">Sem extensão (.xlsx será adicionado automaticamente)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="sheet_organization" class="form-label">Organização das Planilhas</label>
                            <select class="form-select" id="sheet_organization" name="sheet_organization">
                                <option value="by_type">Por Tipo de Dados</option>
                                <option value="by_task">Por Tarefa</option>
                                <option value="single_sheet">Planilha Única</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_summary" 
                                       id="include_summary" checked>
                                <label class="form-check-label" for="include_summary">
                                    Incluir Planilha de Resumo
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_charts" 
                                       id="include_charts">
                                <label class="form-check-label" for="include_charts">
                                    Incluir Gráficos
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros de Data -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-calendar me-1"></i>
                                Filtros de Data
                            </h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date_from" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="date_from" name="date_from">
                            <div class="form-text">Deixe vazio para incluir todos os dados</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date_to" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="date_to" name="date_to">
                        </div>
                    </div>
                    
                    <!-- Botões de Ação -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Resetar
                                </button>
                                
                                <button type="submit" class="btn btn-primary" id="exportBtn">
                                    <i class="bi bi-download me-1"></i>
                                    Gerar Exportação
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Painel de Informações -->
    <div class="col-lg-4">
        <!-- Preview da Exportação -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-eye me-2"></i>
                    Preview da Exportação
                </h6>
            </div>
            <div class="card-body">
                <div id="exportPreview">
                    <p class="text-muted">Configure as opções para ver o preview</p>
                </div>
            </div>
        </div>
        
        <!-- Histórico de Exportações -->
        {% if export_history %}
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Exportações Recentes
                </h6>
            </div>
            <div class="card-body">
                {% for export in export_history %}
                <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                    <div>
                        <strong>{{ export.filename }}</strong>
                        <br>
                        <small class="text-muted">
                            {{ export.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                    </div>
                    <div>
                        {% if export.status == 'completed' %}
                            <a href="{{ url_for('export.download_file', job_id=export.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i>
                            </a>
                        {% elif export.status == 'processing' %}
                            <span class="badge bg-warning">Processando</span>
                        {% elif export.status == 'failed' %}
                            <span class="badge bg-danger">Falhou</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Status de Exportação (Modal) -->
<div class="modal fade" id="exportStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-hourglass-split me-2"></i>
                    Gerando Exportação
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p id="exportStatusText">Preparando exportação...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="exportProgress"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Gerenciamento de seleção de tarefas
function toggleAllTasks() {
    const selectAll = document.getElementById('selectAllTasks');
    const checkboxes = document.querySelectorAll('.task-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updatePreview();
}

// Atualizar preview da exportação
function updatePreview() {
    const selectedTasks = document.querySelectorAll('.task-checkbox:checked').length;
    const selectedDataTypes = document.querySelectorAll('input[name="data_types"]:checked').length;
    const filename = document.getElementById('filename').value || 'facebook_data';
    const organization = document.getElementById('sheet_organization').value;
    const includeSummary = document.getElementById('include_summary').checked;
    const includeCharts = document.getElementById('include_charts').checked;
    
    let organizationText = '';
    switch(organization) {
        case 'by_type': organizationText = 'Por tipo de dados'; break;
        case 'by_task': organizationText = 'Por tarefa'; break;
        case 'single_sheet': organizationText = 'Planilha única'; break;
    }
    
    const preview = `
        <div class="mb-2">
            <strong>Arquivo:</strong> ${filename}.xlsx
        </div>
        <div class="mb-2">
            <strong>Tarefas:</strong> ${selectedTasks || 'Tarefa atual'}
        </div>
        <div class="mb-2">
            <strong>Tipos de dados:</strong> ${selectedDataTypes}
        </div>
        <div class="mb-2">
            <strong>Organização:</strong> ${organizationText}
        </div>
        <div class="mb-2">
            <strong>Extras:</strong> 
            ${includeSummary ? 'Resumo' : ''}
            ${includeSummary && includeCharts ? ', ' : ''}
            ${includeCharts ? 'Gráficos' : ''}
            ${!includeSummary && !includeCharts ? 'Nenhum' : ''}
        </div>
    `;
    
    document.getElementById('exportPreview').innerHTML = preview;
}

// Resetar formulário
function resetForm() {
    if (confirm('Deseja resetar todas as configurações?')) {
        document.getElementById('exportForm').reset();
        updatePreview();
    }
}

// Submissão do formulário
document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validações
    const selectedDataTypes = document.querySelectorAll('input[name="data_types"]:checked');
    if (selectedDataTypes.length === 0) {
        alert('Selecione pelo menos um tipo de dados para exportar.');
        return;
    }
    
    // Se não há tarefa específica, verificar se alguma foi selecionada
    {% if not task %}
    const selectedTasks = document.querySelectorAll('.task-checkbox:checked');
    if (selectedTasks.length === 0) {
        alert('Selecione pelo menos uma tarefa para exportar.');
        return;
    }
    {% endif %}
    
    // Mostrar modal de progresso
    const modal = new bootstrap.Modal(document.getElementById('exportStatusModal'));
    modal.show();
    
    // Desabilitar botão
    const exportBtn = document.getElementById('exportBtn');
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Processando...';
    
    // Enviar formulário via AJAX
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Monitorar progresso
            monitorExportProgress(data.job_id);
        } else {
            modal.hide();
            alert('Erro ao iniciar exportação: ' + data.message);
            resetExportButton();
        }
    })
    .catch(error => {
        modal.hide();
        alert('Erro ao processar exportação: ' + error.message);
        resetExportButton();
    });
});

// Monitorar progresso da exportação
function monitorExportProgress(jobId) {
    const statusText = document.getElementById('exportStatusText');
    const progressBar = document.getElementById('exportProgress');
    
    const checkProgress = () => {
        fetch(`/export/status/${jobId}`)
        .then(response => response.json())
        .then(data => {
            statusText.textContent = data.status_message || 'Processando...';
            progressBar.style.width = (data.progress || 0) + '%';
            
            if (data.status === 'completed') {
                statusText.textContent = 'Exportação concluída!';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    // Fazer download do arquivo
                    window.location.href = `/export/download/${jobId}`;
                    
                    // Fechar modal e resetar
                    bootstrap.Modal.getInstance(document.getElementById('exportStatusModal')).hide();
                    resetExportButton();
                    
                    // Recarregar página para atualizar histórico
                    setTimeout(() => location.reload(), 1000);
                }, 1000);
                
            } else if (data.status === 'failed') {
                statusText.textContent = 'Falha na exportação: ' + (data.error || 'Erro desconhecido');
                progressBar.classList.add('bg-danger');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('exportStatusModal')).hide();
                    resetExportButton();
                }, 3000);
                
            } else {
                // Continuar monitorando
                setTimeout(checkProgress, 2000);
            }
        })
        .catch(error => {
            console.error('Erro ao verificar progresso:', error);
            setTimeout(checkProgress, 5000); // Tentar novamente em 5s
        });
    };
    
    checkProgress();
}

// Resetar botão de exportação
function resetExportButton() {
    const exportBtn = document.getElementById('exportBtn');
    exportBtn.disabled = false;
    exportBtn.innerHTML = '<i class="bi bi-download me-1"></i>Gerar Exportação';
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Listeners para atualizar preview
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', updatePreview);
        input.addEventListener('input', updatePreview);
    });
    
    // Preview inicial
    updatePreview();
    
    // Definir data padrão para filename
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filename').value = `facebook_data_${today}`;
});
</script>
{% endblock %}